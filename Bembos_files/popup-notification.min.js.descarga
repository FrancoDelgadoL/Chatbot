define(['ko','jquery','uiComponent','mage/url','mage/storage','mage/translate','Magento_Ui/js/modal/modal','SummaSolutions_Inventory/js/model/selector-manager','SummaSolutions_Inventory/js/view/source-selector','domReady!'],function(ko,$,Component,url,storage,$t,modal,selectorManager,sourceSelector){'use strict';return Component.extend({sourceCode:null,websiteCode:null,source_data:ko.observable(null),inventorySourceUrl:url.build('inventory/source'),formSelector:'#form-delivery-method .btn-submit',minicartSelector:'#top-cart-btn-checkout',cartSelector:'.cart-summary [data-role="proceed-to-checkout"]',enabled:ko.observable(false),text:ko.observable(''),name:ko.observable(''),source:selectorManager.source,selectedStorePickUp:selectorManager.selectedStorePickUp,selectedSource:selectorManager.pickupSelectedLocation,initialize:function(config,element){let self=this;this.sourceCode=config.source;this.websiteCode=config.websiteCode;let options={type:'popup',responsive:false,modalClass:'popup-notification-modal',buttons:[{text:$t('Change store'),class:'action border-secondary',click:function(event){$(document).trigger('cancelPopupNotification');}},{text:$t('Continue'),class:'action button-large',click:function(event){$(document).trigger('confirmPopupNotification');$(document.body).trigger('processStart')}}],closed:function(){$(document).trigger('closedPopupNotification');}};var popup=modal(options,$('#popup-notification'));$(document).on('cancelPopupNotification',function(){self.closeModal();});$(document).ready(function(){$(document).on("beforeSubmit",function(event,callback){if(self.selectedStorePickUp()){sourceSelector().continueToSubmit(false);$(document).on('confirmPopupNotification',function(){self.closeModal();callback();});$(document).on('closedPopupNotification',function(){self.source(null);});$(document).trigger('showPopupNotification.inventory');}else{sourceSelector().continueToSubmit(true);}});$(document).on("beforeProceedToCheckout",function(event,callback){if(self.getIsPickup()&&self.getSourceCode()!==''){$(document).on('confirmPopupNotification',function(){callback();});$(document).on('cancelPopupNotification',function(){self.redirectToSources();});$(document).trigger('showPopupNotification.cart');}else{callback();}});var minicartInterval=setInterval(function(){if($(self.minicartSelector).length){clearInterval(minicartInterval);$(self.minicartSelector).on("click.popupNotification",function(event){if(self.getIsPickup()&&self.getSourceCode()!==''){event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();$(document).on('confirmPopupNotification',function(){$(self.minicartSelector).off("click.popupNotification");$(self.minicartSelector).click();});$(document).on('cancelPopupNotification',function(){self.redirectToSources();});$(document).trigger('showPopupNotification.minicart');}});}},100);});$(document).on('showPopupNotification.inventory',function(e){self.enabled(self.selectedSource().popup_notification_enabled);let text=self.selectedSource().popup_notification_text||self.getDefaultText();self.text($t(text));self.name(self.selectedSource().name);self.openModal();});$(document).on('showPopupNotification.cart.minicart',function(e){this.sourceDataSubscription=self.source_data.subscribe(function(newValue){let ngr_attributes=newValue.extension_attributes.ngr_source
self.enabled(ngr_attributes.popup_notification_enabled);let text=ngr_attributes.popup_notification_text||self.getDefaultText();self.text($t(text));self.name(newValue.name);self.openModal();});self.getSourceData();});},openModal:function(){if(this.enabled()){$('#popup-notification').modal('openModal');$(document.body).trigger('processStop')}else{$(document).trigger('confirmPopupNotification');$(document.body).trigger('processStart')}},closeModal:function(el,event){$('#popup-notification').modal('closeModal');},redirectToSources:function(){window.location.href=this.inventorySourceUrl;},getDefaultText:function(){return window.popup_notification_text_default;},getStoreCode:function(){return this.storeCode;},getWebsiteCode:function(){return this.websiteCode;},getInventoryData:function(){return selectorManager.getInventoryData();},getIsPickup:function(){var address=selectorManager.getAddressData();return typeof address!=='undefined'&&address.method_code==='instore_pickup';},getSourceName:function(){return selectorManager.getSourceName();},getSourceCode:function(){return selectorManager.getSourceCode();},getSourceData:function(){var self=this;var serviceUrl=this.getUrlForPickupLocation(this.getSourceCode());return storage.get(serviceUrl,{},false).then(function(result){var addresses=result.items||[],source=addresses[0]||{};self.source_data(source);}).fail(function(response){self.source_data(null);});},getUrlForPickupLocation:function(sourceCode){let method='rest',version='V1',endpoint='inventory/in-store-pickup/pickup-locations';let urlParts=[method,this.getStoreCode(),version,endpoint];let completeUrl=urlParts.join('/');let searchRequest={searchRequest:{filters:{pickupLocationCode:{value:sourceCode}},scopeCode:this.getWebsiteCode()}};return url.build(completeUrl)+'?'+$.param(searchRequest);}})});