define(["jquery"],function($){"use strict"
return function(LayoutRender){return LayoutRender.extend({getRecs:async function(){this.recsFetcher.fetchPagePreconfigured().then(function(response){var units=this.processResponse(response);units=units.filter(unit=>unit.pagePlacement===this.pagePlacement&&unit.products.length>0,);units.forEach(unit=>{if(unit.products&&unit.products.length&&this.ias_config&&this.ias_config.api_url){var skusToExtend=[];unit.products.forEach(product=>{skusToExtend.push(product.sku);});var unitAux=unit;skusToExtend=skusToExtend.join(',');$.getJSON(this.ias_config.api_url,{"unitId":unit.unitId,"skus":skusToExtend}).done(function(magentoResponse){if(magentoResponse.data){unitAux.htmlRendered=magentoResponse.data
this.recs.push(unitAux);}}.bind(this)).fail(function(jqXHR){throw new Error(jqXHR);}.bind(this));}else{this.recs.push(unit)}})}.bind(this),)},loadJsAfterKoRender:function(self,unit){this._super();setTimeout(function(){let container=$('[data-unit-id="'+unit.unitId+'"]');if(container.length){container.find('a').attr('data-unit-id',unit.unitId);container.find('[name=form_key]').val($.cookie('form_key'));let currentLocationUENC=encodeURIComponent(this.encodeUenc(document.location.href));let elem,data,parsedUrl;container.find('[name=uenc]').val(currentLocationUENC);container.find('[data-role=tocart-form]').each(function(){elem=$(this);parsedUrl=elem.attr('action').split('/uenc/');parsedUrl
elem.attr('action',parsedUrl[0]+'/uenc/'+currentLocationUENC+parsedUrl[1].substring(parsedUrl[1].indexOf("/")))});container.find('[data-post]').each(function(){elem=$(this);data=JSON.parse(elem.attr('data-post'));if(data.data&&data.data.uenc){data.data.uenc=currentLocationUENC;}
elem.attr('data-post',JSON.stringify(data));});container.trigger('contentUpdated');container.trigger('iasProductRecommendationsRendered');}}.bind(this),20);}});}})