define(['ko','jquery','uiComponent','SummaSolutions_Inventory/js/model/selector-manager','Magento_Customer/js/customer-data','Magento_Checkout/js/checkout-data','mage/storage','mage/url','SummaTheme_StorePickup/js/model/data','SummaSolutions_Inventory/js/view/store-is-open','Magento_Catalog/js/price-utils'],function(ko,$,Component,selectorManager,customerData,checkoutData,storage,url,storePickupData,storeIsOpen,priceUtils){let lastFetchedCoords=null;let debounceTimeout=null;function isSameCoords(a,b){return a?.latitude===b?.latitude&&a?.longitude===b?.longitude;}
function parseAddressComponents(address){if(!address||!address.address_components)return{};const get=(type)=>{const comp=address.address_components.find(ac=>ac.types.includes(type));return comp?comp.long_name:null;};return{street:get('route'),district:get('administrative_area_level_2')||get('colloquial_area'),city:get('locality'),region:get('administrative_area_level_1'),postcode:get('postal_code'),country_id:get('country')};}
return Component.extend({defaults:{sourceStockDefault:false},selectedDelivery:selectorManager.selectedDelivery,selectedStorePickUp:selectorManager.selectedStorePickUp,pickupSelectedLocation:selectorManager.pickupSelectedLocation,inventoryData:selectorManager.inventoryData,noCoverageArea:ko.observable(false),productsOutStock:ko.observableArray([]),sourceStockDefault:ko.observable(false),selectedAddress:ko.observable({}),formAddress:'',autocompleteCurrentPlace:selectorManager.autocompleteCurrentPlace,positionOnMapPlace:selectorManager.positionOnMapPlace,selectedSource:selectorManager.source,closedStoreNameMessages:ko.observable(false),timeOpenDelivery:ko.observable(false),countDownSeconds:ko.observable(false),closedScheduleMessages:ko.observable(false),closedFrontendDescriptions:ko.observable(false),onlyPickUp:ko.observable(false),selectedSourceCode:ko.computed(function(){return selectorManager.source()?selectorManager.source().source_code:'';}),messages:ko.observableArray([]),isCheckPolygonActive:null,customerDirectoryData:customerData.get('directory-data'),cart:customerData.get('cart'),continueToSubmit:ko.observable(true),hasValidShippingConfig:ko.observable(false),shippingMinAmount:ko.observable(null),isShippingConfigInitialized:ko.observable(false),showTooltipSuggestion:selectorManager.showTooltipSuggestion,initialize:function(){this._super();this.initObservable();},afterRender:function(){let that=this;this.hashCheck();window.addEventListener('hashchange',()=>{that.hashCheck();$('html').removeClass('nav-open').removeClass('nav-before-open');$('body').removeClass('horizontal-navigation-open');});$('.form-control-mobile').show();$('.btn-submit').show();},hashCheck:function(){let hash=window.location.hash;if(hash=='#retiro'){this.selectStorePickUpShipping();}
if(hash=='#delivery'){this.selectDeliveryShipping();}},initObservable:function(){this._super().observe('sourceStockDefault');this.isCheckPolygonActive=ko.computed(function(){return((this.selectedStorePickUp()&&!!this.pickupSelectedLocation())||(this.selectedDelivery()&&this.autocompleteCurrentPlace()));}.bind(this));this.autocompleteCurrentPlace.subscribe(function(data){this.closedStoreNameMessages(false);this.onlyPickUp(false);this.clearMessages();this.scheduleShippingUpdate(data?.latitude,data?.longitude);}.bind(this));this.positionOnMapPlace.subscribe(function(data){$('#address-autocomplete').val(data.formatted_address);this.scheduleShippingUpdate(data?.latitude,data?.longitude);}.bind(this));this.inventoryData.subscribe(function(data){if(selectorManager.getAddressData().method_code!=='flatrate_flatrate'&&selectorManager.getAddressData().method_code!==undefined){this.selectStorePickUpShipping();}}.bind(this));this.cart.subscribe(function(data){this.clearMessages();}.bind(this));return this;},selectDeliveryShipping:function(){$('#maincontent').addClass('has-selected-item');this.selectedDelivery(true);this.selectedStorePickUp(false);selectorManager.showTooltipSuggestion(false);this.noCoverageArea(false);this.selectedSource(null);this.clearMessages();let detailInteraction={'event':'user_interaction','element':'delivery','action':'click','section':'¿comó quieres hacer tu pedido?',};$(document).trigger('shippingSelectUserInteraction',detailInteraction);$('#selected_delivery_type_gtm').val('delivery');},selectStorePickUpShipping:function(){$('#maincontent').addClass('has-selected-item');this.selectedDelivery(false);this.selectedStorePickUp(true);const result=selectorManager.lastPolygonResult();const storeHasDelivery=result?.length>0;if(selectorManager.pickupSelectedLocation()&&storeHasDelivery){selectorManager.showTooltipSuggestion(true);}else{selectorManager.showTooltipSuggestion(false);}
this.noCoverageArea(false);this.selectedSource(null);this.clearMessages();let detailInteraction={'event':'user_interaction','element':'pickup','action':'click','section':'¿comó quieres hacer tu pedido?',};$(document).trigger('shippingSelectUserInteraction',detailInteraction);$('#selected_delivery_type_gtm').val('pickup');},selectedShippingMethodCode:function(){return(this.selectedDelivery())?'flatrate_flatrate':'instore_pickup';},isLoading:function(){return false;},goToBack:function(){let detailInteraction={'event':'user_interaction','element':'volver atras','action':'click','section':'ingresa tu dirección',};$(document).trigger('goBackUserInteraction',detailInteraction);window.location.href='/';},getCurrentCords:function(){if(this.selectedDelivery()){if(this.autocompleteCurrentPlace()&&this.autocompleteCurrentPlace().latitude&&this.autocompleteCurrentPlace().longitude){return{latitude:this.autocompleteCurrentPlace().latitude,longitude:this.autocompleteCurrentPlace().longitude,}}}else{if(this.selectedStorePickUp()&&this.pickupSelectedLocation()){return{latitude:this.pickupSelectedLocation().latitude,longitude:this.pickupSelectedLocation().longitude,}}}
return null;},checkPolygon:function(){this.clearMessages();if(!this.isCheckPolygonActive()){return this;}
var detailInteraction='';let currentCoords=this.getCurrentCords();if(currentCoords){this.selectedAddress({});if(this.selectedStorePickUp()){this.selectedSource({source_code:this.pickupSelectedLocation().pickup_location_code});this.selectedAddress().latitude=currentCoords.latitude;this.selectedAddress().longitude=currentCoords.longitude;this.validateStock();detailInteraction={'event':'user_interaction','element':'confirmar selección','action':'click','section':'consigue el local de tu preferencia :: '+this.pickupSelectedLocation().name,};}else{var self=this;$(document.body).trigger('processStart');storage.get(`rest/V1/polygon/source/cover/long/${currentCoords.longitude}/lat/${currentCoords.latitude}`).done(function(result){if(result.length){if(self.storeIsOpen(result[0].source_code)){self.selectedSource(result[0]);self.selectedAddress().latitude=currentCoords.latitude;self.selectedAddress().longitude=currentCoords.longitude;if(self.autocompleteCurrentPlace().addressId){self.selectedAddress().addressId=self.autocompleteCurrentPlace().addressId;}
if(self.autocompleteCurrentPlace().inline){self.selectedAddress().inline=self.autocompleteCurrentPlace().inline;}
self.validateStock();}else{$(document.body).trigger('processStop');}}else{self.noCoverageArea(true);self.addNoCoverageMessage();customerData.reload(['messages'],true);$(document.body).trigger('processStop');}}).fail(function(){self.noCoverageArea(true);self.addNoCoverageMessage();customerData.reload(['messages'],true);$(document.body).trigger('processStop');}.bind(this)).always(function(){$(document.body).trigger('processStop');});detailInteraction={'event':'user_interaction','element':'confirmar','action':'click','section':'ingresa tu direccion :: confirma tu direccion',};}
$(document).trigger('shippingSelectUserInteraction',detailInteraction);}else{this.addNoPlaceMessage();}},storeIsOpen:function(storeSelected){let stores=storePickupData.stores(),is_open_info=false,store_info;$(stores).each(function(index,store){if(store[1]===storeSelected){is_open_info=storeIsOpen().storeIsOpen(store);store_info=store;return false;}});if(is_open_info!==false&&!is_open_info.delivery.isOpen){if(is_open_info.pickup.isOpen){this.initCountDown();this.onlyPickUp(storeSelected);}
this.closedStoreNameMessages(store_info.name);$(document.body).trigger('processStop');this.timeOpenDelivery(is_open_info.delivery.timeFrom);this.closedScheduleMessages(is_open_info.delivery.closeMsg);this.closedFrontendDescriptions(store_info.description.replace('<p>','').replace('</p>',''));return false;}
return true;},initCountDown:function(){let timer=5,that=this,seconds;let redirect=setInterval(function(){seconds=parseInt(timer);seconds=seconds<10?'0'+seconds:seconds;--timer;that.countDownSeconds(seconds);if(timer<0){clearInterval(redirect);that.countDownSeconds(false);that.selectStorePickUpShipping();}},1000);},addMessage:function(message,level,additionalClasses){if(!level){level='error';}
if(!additionalClasses){additionalClasses='';}
this.messages.push({message:message,level:level,additionalClasses:additionalClasses})},clearMessages:function(){this.messages([]);},addNoCoverageMessage:function(){this.initCountDown();this.onlyPickUp(true);this.addMessage('Lo sentimos, tu dirección solo tiene la opción de retiro en tienda',null,'no-coverage');let errorDelivery={'event':'site_error',"error_message":"No se encontró cobertura para la ubicación solicitada","error_type":"system","error_place":"inventory source","section":"envío a domicilio"}
$(document).trigger('shippingSelectUserInteraction',errorDelivery);$('.shipping-message-container').addClass('hidden');},addNoPlaceMessage:function(){if(this.selectedDelivery()){this.addMessage('Porfavor seleccione una ubicación válida',null,'no-autocomplete-place');}else{if(this.selectedStorePickUp()){this.addMessage('Porfavor seleccione una sucursal.',null,'no-location-selected');}}},validateStock:function(){const self=this,formSelector=this.formAddress?this.formAddress:'#form-delivery-method',urlBuilder=url.build('rest/V1/inventory/validateitemstock'),params={"params":{"sourceCode":this.selectedSourceCode(),"transformSource":this.selectedDelivery()}};$(document.body).trigger('processStart');this.productsOutStock.removeAll();$.ajax({url:urlBuilder,type:'POST',contentType:'application/json; charset=utf-8',data:JSON.stringify(params),dataType:"json",async:true,success:function(data){$(document.body).trigger('processStart');const items=JSON.parse(data);self.productsOutStock(items);if(!self.productsOutStock().length){self.selectedAddress().method_code=self.selectedShippingMethodCode();let customerCheckoutData=checkoutData.getShippingAddressFromData();if(!customerCheckoutData){customerCheckoutData={country_id:'PE'};}
if(!customerCheckoutData.custom_attributes){customerCheckoutData.custom_attributes={}}
if(self.selectedDelivery()){customerCheckoutData.method_code=self.selectedAddress().method_code;if(self.selectedAddress().addressId){checkoutData.setSelectedShippingAddress('customer-address'+self.selectedAddress().addressId);checkoutData.setShippingAddressFromData({});checkoutData.setSelectedShippingRate(self.selectedShippingMethodCode());customerCheckoutData.place=JSON.stringify(self.selectedAddress());customerCheckoutData.placeText=self.selectedAddress().inline;$('#address_data').val(JSON.stringify(customerCheckoutData));}else{customerCheckoutData.city=selectorManager.addressData().locality;customerCheckoutData.postcode=selectorManager.addressData().postal_code;customerCheckoutData.street=[selectorManager.addressData().route];if(selectorManager.addressData().street_number){customerCheckoutData.street.push(selectorManager.addressData().street_number);}
customerCheckoutData.custom_attributes.district=selectorManager.addressData().administrative_area_level_1
customerCheckoutData.custom_attributes.latitude=self.selectedAddress().latitude;customerCheckoutData.custom_attributes.longitude=self.selectedAddress().longitude;let directoryRegions=Object.entries(self.customerDirectoryData()['PE'].regions);if(directoryRegions){directoryRegions.forEach(function(item){if(item[1].name===selectorManager.addressData().locality){customerCheckoutData.region_id=item[0];}});}
checkoutData.setSelectedShippingAddress('new-customer-address');checkoutData.setSelectedShippingRate(self.selectedShippingMethodCode());checkoutData.setShippingAddressFromData(customerCheckoutData);customerCheckoutData.place=JSON.stringify(self.autocompleteCurrentPlace());customerCheckoutData.placeText=$('#address-autocomplete').val();$('#address_data').val(JSON.stringify(customerCheckoutData));}}else{customerCheckoutData.custom_attributes.latitude=self.selectedAddress().latitude;customerCheckoutData.custom_attributes.longitude=self.selectedAddress().longitude;checkoutData.setSelectedShippingAddress('store-pickup-address'+self.selectedSourceCode())
checkoutData.setSelectedShippingRate(self.selectedShippingMethodCode());checkoutData.setSelectedPickupAddress(null);checkoutData.setShippingAddressFromData(null);$('#address_data').val(JSON.stringify(self.selectedAddress()));}
self.submitForm(formSelector);}else{$(document.body).trigger('processStop');}}}).fail(function(){$(document.body).trigger('processStop');}).always(function(){$(document.body).trigger('processStop');});},noStockItemsActionConfirm:function(){const formSelector=this.formAddress?this.formAddress:'#form-delivery-method';this.removeItemsOutOfStock(formSelector);},noStockItemsActionCancel:function(){this.productsOutStock.removeAll();this.selectedSource(null);this.pickupSelectedLocation(null);},getFormattedPrice:function(data){var priceFormat={decimalSymbol:'.',groupLength:3,groupSymbol:",",integerRequired:false,pattern:"S/ %s",precision:2,requiredPrecision:2};const total=(Number(data.price)*Number(data.qty));return priceUtils.formatPrice(total,priceFormat);},removeItemsOutOfStock:function(formSelector){const urlBuilder=url.build('rest/V1/inventory/removeitems');if(this.productsOutStock().length){self=this;const items=[];this.productsOutStock().forEach(function(item){items.push({'id':item.item_id,});});const params={"params":{items}};$.ajax({url:urlBuilder,type:'POST',contentType:'application/json; charset=utf-8',data:JSON.stringify(params),dataType:"json",showLoader:true,async:true,success:function(data){self.validateStock();customerData.reload(['cart']);$(document.body).trigger('processStop');}}).fail(function(){$(document.body).trigger('processStop');}).always(function(){$(document.body).trigger('processStop');});}else{this.submitForm(formSelector);}},submitForm:function(formSelector){this.continueToSubmit(true);$(document).trigger('beforeSubmit',function(){$(formSelector).submit();});if(this.continueToSubmit()){$(formSelector).submit();}},updateFreeShippingAmount:function(lat,lng){if(!window.shippingConfig?.isEnabled)return;if(!lat||!lng)return;const self=this;if(ko.isObservable(self.isShippingConfigInitialized)){self.isShippingConfigInitialized(false);}
const newCoords={latitude:lat,longitude:lng};if(isSameCoords(newCoords,lastFetchedCoords)&&!self.forceRefreshShipping)return;lastFetchedCoords=newCoords;self.forceRefreshShipping=false;const isAdminEnabled=window.shippingConfig?.isAdminMinAmountConfigEnabled===true;const isFreeShippingGloballyEnabled=window.shippingConfig?.isFreeShippingEnabled===true;const adminDefault=parseFloat(window.shippingConfig.freeShippingAmount||0);fetch(`/rest/V1/polygon/source/cover/long/${lng}/lat/${lat}`).then(res=>res.json()).then(polygonData=>{if(polygonData&&polygonData[0]&&polygonData[0].source_code){const sourceCode=polygonData[0].source_code;fetch(`/rest/V1/shipping/source/minimo/${sourceCode}`).then(res=>res.json()).then(config=>{let monto=0;let isValid=false;if(isFreeShippingGloballyEnabled&&config&&config.success!==false&&config.monto_minimo&&config.monto_minimo>0){monto=parseFloat(config.monto_minimo);isValid=true;}else if(isAdminEnabled&&adminDefault>0){monto=adminDefault;isValid=true;window.originalFreeShippingAmount=monto;}
if(!window.inventoryShippingMessage){window.inventoryShippingMessage={};}
if(!ko.isObservable(window.inventoryShippingMessage.shippingMinAmount)){window.inventoryShippingMessage.shippingMinAmount=ko.observable();}
if(!ko.isObservable(window.inventoryShippingMessage.hasValidShippingConfig)){window.inventoryShippingMessage.hasValidShippingConfig=ko.observable(false);}
window.inventoryShippingMessage.shippingMinAmount(monto);window.inventoryShippingMessage.hasValidShippingConfig(isValid);if(ko.isObservable(self.shippingMinAmount)){self.shippingMinAmount(monto);}
if(ko.isObservable(self.hasValidShippingConfig)){self.hasValidShippingConfig(isValid);}
if(ko.isObservable(self.isShippingConfigInitialized)){self.isShippingConfigInitialized(true);}});}});},scheduleShippingUpdate:function(lat,lng){if(!lat||!lng)return;clearTimeout(debounceTimeout);debounceTimeout=setTimeout(()=>{this.forceRefreshShipping=true;this.updateFreeShippingAmount(lat,lng);},50);},selectDeliverySuggestion:function(){const location=selectorManager.tooltipSuggestedStore()||selectorManager.pickupSelectedLocation();if(!location){console.warn('No hay tienda sugerida para delivery');return;}
this.selectedDelivery(true);this.selectedStorePickUp(false);const addressData=location.address_components?parseAddressComponents(location):location;const formattedAddress=[addressData.street,addressData.district,addressData.city,addressData.region,addressData.postcode,addressData.country_id].filter(Boolean).join(', ');$('#address-autocomplete').val(formattedAddress);selectorManager.autocompleteCurrentPlace({latitude:location.latitude,longitude:location.longitude,inline:formattedAddress,addressId:null});selectorManager.tooltipSuggestedStore(null);selectorManager.showTooltipSuggestion(false);}});});