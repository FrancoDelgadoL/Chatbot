define(['jquery','Magento_Customer/js/customer-data','Magento_Catalog/js/price-utils','mage/mage','jquery/jquery-storageapi'],function($,customerData,priceUtils){"use strict";return function(data){let gtmData=customerData.get('gtm'),cartData=customerData.get('cart'),processAddToCart=data.addToCart,processAddToWishlist=data.addToWishlist,processViewCart=data.viewCart,infraGtmItemViewed=false,processCheckout=data.processCheckout,$storage=$.localStorage,lastProcessedTimestamp=false,isCartPage=$('body').hasClass('checkout-cart-index');if(!Array.isArray(window.dataLayer)){window.dataLayer=[];}
let gtm={onGtmChange:function(gtmData){if(gtmData&&gtmData['datalayer']){let parsedDatalayer=JSON.parse(gtmData['datalayer']);if(Object.keys(parsedDatalayer).length){if(processCheckout){if(parsedDatalayer['order']){this.pushCheckoutOrderData(parsedDatalayer['order'])}
if(parsedDatalayer?.checkout_steps&&lastProcessedTimestamp!=parsedDatalayer?.checkout_steps?.timestamp){lastProcessedTimestamp=parsedDatalayer.checkout_steps.timestamp;delete parsedDatalayer.checkout_steps.timestamp;this.processCheckoutStepData(Object.values(parsedDatalayer.checkout_steps));}}
if(processAddToCart){if(parsedDatalayer['add_to_cart']&&lastProcessedTimestamp!=parsedDatalayer?.add_to_cart?.timestamp){lastProcessedTimestamp=parsedDatalayer.add_to_cart.timestamp;delete parsedDatalayer.add_to_cart.timestamp;this.pushAddToCart(parsedDatalayer['add_to_cart'])}}}}},processCheckoutStepData:function(gtmStepsData){gtmStepsData.forEach(function(stepData,i){this.pushCheckoutData(stepData)}.bind(this));customerData.invalidate(['gtm']);},pushAddToCart:function(impressionToPush){window.dataLayer.push(impressionToPush);customerData.invalidate(['gtm']);},pushViewItemData:function(gtmViewItemData){if(!infraGtmItemViewed){window.dataLayer.push(gtmViewItemData);infraGtmItemViewed=true;}},pushCheckoutData:function(gtmData){let processedGtmData=gtmData,pushedImpressions=$storage.get('infra-gtm-added-to-cart')??{};$storage.remove('infra-gtm-add-to-cart-pending');gtmData.ecommerce.items.forEach(function(item,i){if(pushedImpressions[item['storage_key']]){processedGtmData['ecommerce']['items'][i]['item_list_name']=pushedImpressions[item['storage_key']]['ecommerce']['items'][0]['item_list_name'];}
delete processedGtmData['ecommerce']['items'][i]['storage_key'];});window.dataLayer.push(processedGtmData);},pushCheckoutOrderData:function(gtmOrderData){let processedGtmData=gtmOrderData,pushedImpressions=$storage.get('infra-gtm-added-to-cart')??{};gtmOrderData.ecommerce.items.forEach(function(item,i){if(pushedImpressions[item['storage_key']]){processedGtmData['ecommerce']['items'][i]['item_list_name']=pushedImpressions[item['storage_key']]['ecommerce']['items'][0]['item_list_name'];}
processedGtmData['ecommerce']['items'][i]['index']=i+1;const clickedItems=JSON.parse(sessionStorage.getItem("clicked_items")||"[]");const matchedClick=clickedItems.find(c=>c.item_id===item.item_id);processedGtmData['ecommerce']['items'][i]['carrusel_source']=matchedClick?matchedClick.carrusel_source:'';delete processedGtmData['ecommerce']['items'][i]['storage_key'];});sessionStorage.removeItem("clicked_items");$storage.remove('infra-gtm-add-to-cart-pending');$storage.remove('infra-gtm-added-to-cart');window.dataLayer.push(processedGtmData);customerData.invalidate(['gtm']);}};if(processCheckout&&window.checkoutConfig&&window.checkoutConfig.infraGtm){gtm.pushCheckoutData(window.checkoutConfig.infraGtm['datalayer']);}
function notify(){gtmData.subscribe(function(gtmData){gtm.onGtmChange(gtmData);});gtm.onGtmChange(gtmData());}
function onGAInited(callback){const checkEvent=(event)=>{if(event.event==='gtm.dom'){callback();}};const originalPush=window.dataLayer.push;window.dataLayer.push=function(){Array.prototype.forEach.call(arguments,checkEvent);return originalPush.apply(window.dataLayer,arguments);};window.dataLayer.forEach(checkEvent);}
onGAInited(notify);};});