define(['jquery','ko','uiComponent','SummaTheme_StorePickup/js/model/data','uiLayout','mage/translate'],function($,ko,Component,storePickupData,layout,$t){'use strict';return Component.extend({defaults:{initialStores:[],filterByRegion:1,filterByCity:1,filterByDistrict:1,closestStore:1,selectFirstStore:0,mapComponent:{name:'${ $.name }_map',parentName:'${ $.name }',displayArea:'store-map',component:'SummaTheme_StorePickup/js/view/maps/map-renderer',mapName:'store-map',renderStoresWithoutLocation:true,markerImageUrl:false,markerActiveImageUrl:false,googleApiKey:false,mapInstanceType:false}},selectedLocation:storePickupData.selectedLocation,filteredStores:storePickupData.filteredStores,stores:storePickupData.stores,geolocationPosition:ko.observable(false),geoPositionLoading:ko.observable(false),geolocationError:ko.observable(null),geoPositionSuccessVisible:ko.observable(false),noFilterStores:false,othersText:$t('Others'),regions:ko.observableArray([]),cities:ko.observableArray([]),districts:ko.observableArray([]),regionSelected:ko.observable(false),citySelected:ko.observable(false),districtSelected:ko.observable(false),filteringFlag:false,orderingFlag:false,visible:ko.observable(false),isLoading:ko.observable(false),initialize:function(){this._super();this.subscribeFilters();this.stores.subscribe(function(){if(!this.orderingFlag){this.orderingFlag=true;this.onStoresChange();this.orderingFlag=false;}},this);if(this.initialStores.length){this.stores(this.orderStoresByDistance(this.initialStores));}
this.visible(true);return this;},onStoresChange:function(){this.stores(this.orderStoresByDistance(this.stores()));this.setOrderedFilterStores(this.stores());this.initSortStores();this.initFilters();this.insertMap();if(this.filterByRegion){if(this.regionSelected()&&this.regions.indexOf(this.regionSelected())===-1){this.regionSelected('');this.citySelected('');this.districtSelected('');}else{if(this.citySelected()&&this.cities.indexOf(this.citySelected())===-1){this.citySelected('');this.districtSelected('');}else{if(this.districtSelected()&&this.districts.indexOf(this.districtSelected())===-1){this.districtSelected('');}}}}
if(this.selectFirstStore&&this.filteredStores().length||this.filteredStores().length===1){this.selectStore(this.filteredStores()[0]);}},insertMap:function(){if(this.stores().length&&!this.getRegion(this.mapComponent.displayArea)().length){layout([this.mapComponent],this);}},selectStore:function(location){if(this.isPickupLocationSelected(location)){this.selectedLocation(null);}else{this.selectedLocation(location);}},changeStore:function(){this.selectedLocation(null)},isPickupLocationSelected:function(location){return _.isEqual(this.selectedLocation(),location);},subscribeFilters:function(){this.regionSelected.subscribe(function(){this.setStoresByRegion();},this);if(this.filterByCity){this.citySelected.subscribe(function(){this.setStoresByCity();},this);if(this.filterByDistrict){this.districtSelected.subscribe(function(){this.setStoresByDistrict();},this);}}
this.filteredStores.subscribe(function(){if(this.selectedLocation()){let found=this.filteredStores().some(function(store){return store.pickup_location_code===this.selectedLocation().pickup_location_code;}.bind(this));if(!found){this.selectedLocation(null);}}},this);},initFilters:function(){if(this.filterByRegion){this.noFilterStores=this.stores();this.setRegions();}},setRegions:function(){let itemsRegions=[],regions=[],pushOthers=false;this.regions([]);if(this.filteredStores().length){this.filteredStores().forEach(function(store){if(store.region){itemsRegions.push(store.region);}else{pushOthers=false;}}.bind(this));if(pushOthers){itemsRegions.push(this.othersText);}
itemsRegions.forEach(function(store){if($.inArray(store,regions)===-1)regions.push(store);});this.regions(regions);if(regions.length==1){this.regionSelected(regions[0]);}}},setCities:function(){let itemsCities=[],cities=[],pushOthers=false;this.cities([]);if(this.regionSelected()&&this.filteredStores().length){this.filteredStores().forEach(function(store){if(store.city){itemsCities.push(store.city);}else{pushOthers=true;}}.bind(this));if(pushOthers){itemsCities.push(this.othersText);}
itemsCities.forEach(function(store){if($.inArray(store,cities)===-1)cities.push(store);});this.cities(cities);if(cities.length===1){this.citySelected(cities[0]);}}},setDistricts:function(){let itemsDistricts=[],districts=[],pushOthers=false;this.districts([]);if(this.regionSelected()&&this.citySelected()&&this.filteredStores().length){this.filteredStores().forEach(function(store){if(store&&store.district){itemsDistricts.push(store.district);}else{pushOthers=true;}}.bind(this));if(pushOthers){itemsDistricts.push(this.othersText);}
itemsDistricts.forEach(function(store){if($.inArray(store,districts)===-1)districts.push(store);});this.districts(districts);if(districts.length===1){this.districtSelected(districts[0]);}}},setStoresByDistrict:function(){if(!this.filteringFlag){if(this.regionSelected()){let filteredStores=this.filterStoresByLocation(this.noFilterStores,this.regionSelected(),'region');if(this.citySelected()){filteredStores=this.filterStoresByLocation(filteredStores,this.citySelected(),'city');if(this.districtSelected()){filteredStores=this.filterStoresByLocation(filteredStores,this.districtSelected(),'district',true);}}
this.setOrderedFilterStores(filteredStores);}}},filterStoresByLocation:function(locations,selectedValue,key,customAttribute){var filteredStores=[],storeKeyValue;locations.forEach(function(store){storeKeyValue=(customAttribute&&store['custom_attributes'])?store['custom_attributes'][key]:store[key];if(storeKeyValue==selectedValue){filteredStores.push(store);}else{if(selectedValue==this.othersText&&!storeKeyValue){filteredStores.push(store);}}}.bind(this));return filteredStores;},setStoresByRegion:function(){this.filteringFlag=true;if(this.filterByCity){this.citySelected('');this.cities([]);if(this.filterByDistrict){this.districtSelected('');this.districts([]);}}
var filteredStores=this.noFilterStores;if(this.regionSelected()){filteredStores=this.filterStoresByLocation(filteredStores,this.regionSelected(),'region')}
this.setOrderedFilterStores(filteredStores);this.filteringFlag=false;if(this.filterByCity){this.setCities();}},setStoresByCity:function(){if(!this.filteringFlag){if(this.regionSelected()){let filteredStores=this.filterStoresByLocation(this.noFilterStores,this.regionSelected(),'region');if(this.citySelected()){filteredStores=this.filterStoresByLocation(filteredStores,this.citySelected(),'city');}
this.setOrderedFilterStores(filteredStores);}
if(this.filterByDistrict){this.setDistricts();}}},initSortStores:function(){if(this.closestStore){this._loadCurrentPosition();if(this.filteredStores().length){this.setOrderedFilterStores();}}},setOrderedFilterStores:function(stores){stores=this.orderStoresByDistance(stores);let selectLocationCode=(this.selectedLocation())?this.selectedLocation().pickup_location_code:false;this.filteredStores([]);this.filteredStores(stores);if(selectLocationCode){let selectedLocation=this.filteredStores().find(store=>store.pickup_location_code==selectLocationCode);if(selectedLocation){this.selectedLocation(selectedLocation);}}},orderStoresByDistance:function(stores){if(!stores){stores=this.filteredStores();}
if(this.closestStore&&stores&&stores.length&&this.geolocationPosition()){let orderedStores=[],noCoordsStores=[];stores.forEach(function(store,index){if(typeof(store['original_position'])==='undefined'){store['original_position']=index;}
store['closest_store']=false;store['distance']=this.getDistance(this.geolocationPosition().coords.latitude,this.geolocationPosition().coords.longitude,store.latitude,store.longitude);if(store.latitude&&store.longitude){orderedStores.push(store);}else{noCoordsStores.push(store);}}.bind(this));orderedStores.sort(function(a,b){return parseFloat(a.distance)-parseFloat(b.distance)});orderedStores=orderedStores.concat(noCoordsStores);orderedStores[0].closest_store=true;stores=orderedStores;}
return stores;},_loadCurrentPosition:function(){if(!this.geolocationPosition()&&!this.geolocationError()){this._getCurrentPosition().then((position)=>{this.geoPositionLoading(false);this.geoPositionSuccessVisible(true);this.geolocationPosition(position);this.setOrderedFilterStores();setTimeout(function(){this.geoPositionSuccessVisible(false);}.bind(this),5000);}).catch((error)=>{this.geoPositionLoading(false);console.error('Geolocation error: '+error.message);this.geolocationError(true)});}else{if(this.geolocationPosition()){this.setOrderedFilterStores();}}},_getCurrentPosition:function(){if(navigator.geolocation){this.geoPositionLoading(true);return new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(resolve,reject))}else{return new Promise(resolve=>resolve({}))}},getDistance:function(lat1,lon1,lat2,lon2){let radlat1=Math.PI*lat1/180,radlat2=Math.PI*lat2/180,theta=lon1-lon2,radtheta=Math.PI*theta/180,dist=Math.sin(radlat1)*Math.sin(radlat2)+Math.cos(radlat1)*Math.cos(radlat2)*Math.cos(radtheta);if(dist>1){dist=1;}
dist=Math.acos(dist);dist=dist*180/Math.PI;dist=dist*60*1.1515;dist=dist*1.609344;return dist}});});