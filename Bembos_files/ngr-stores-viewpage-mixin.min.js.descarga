define(['jquery','knockout','jquery-ui-modules/autocomplete'],function($,ko){'use strict';return function(Component){return Component.extend({hasQuery:ko.observable(false),notFound:ko.observable(false),uniqueResult:ko.observable(false),allDone:ko.observable(false),inputFilter:$('#filter-stores'),formatLocationName:function(location){let baseName=location&&location.name?location.name.trim():'',code=location&&location.pickup_location_code;if(!baseName&&code){return code;}
return baseName;},onContainerRendered:function(location){this.initAutocomplete();$('.nav-3.level-top').addClass('active');this.selectedLocation.subscribe(function(value){if(value!=null){$('html, body').animate({scrollTop:$('.storepickup-content').offset().top-100},200);}},this);},initAutocomplete:function(location){let self=this,availableTags=[];for(let x in this.initialStores){let locationData=this.initialStores[x],formattedName=this.formatLocationName(locationData),cityPrefix=locationData.city?locationData.city+' - ':'';locationData.name=formattedName;locationData.name2=cityPrefix+formattedName;locationData.district2=cityPrefix+(locationData.district||'');if(locationData.name2&&$.inArray(locationData.name2,availableTags)===-1){availableTags.push(locationData.name2);}}
availableTags.sort();this.inputFilter.on("input",function(event){self.filterResult(this.value);}).autocomplete({source:availableTags,minLength:0,select:function(event,ui){self.filterResult(ui.item.value);self.hasQuery(true);$(document).trigger('storeSelectFormInteraction',[ui.item.value]);}}).focus(function(){$(this).autocomplete("search");});this.allDone(true);},hideMap:function(location){this.selectedLocation(null);},clearInput:function(){this.selectedLocation(null);this.filteredStores(this.initialStores);this.hasQuery(false);this.uniqueResult(false);this.inputFilter.val('')},makeLowerCase:function(value){if(value===undefined||value===null){return'';}
return String(value).toLowerCase();},selectStore:function(location){this._super();let detailInteraction={'event':'user_interaction','element':'VER LOCAL','tienda':location.name,'action':'click','section':'encuentra el local que necesitas',};window.dataLayer.push(detailInteraction);},filterResult:function(value){let payload=this.initialStores,query=this.makeLowerCase(value);let dataDisplay=payload.filter((eventData)=>{if(query===''){return eventData;}
let searchableFields=[this.makeLowerCase(eventData.name2),this.makeLowerCase(eventData.district2),this.makeLowerCase(eventData.region),this.makeLowerCase(eventData.city),this.makeLowerCase(eventData.pickup_location_code)];return searchableFields.some(function(field){return field&&field.includes(query);});});this.filteredStores(dataDisplay);this.notFound(false);this.uniqueResult(false);this.hasQuery(true);if(dataDisplay.length==0){this.notFound(true);this.filteredStores(payload);this.selectedLocation(null);}
if(dataDisplay.length==1){this.selectedLocation(dataDisplay[0]);this.uniqueResult(true);}else{this.selectedLocation(null);}},});}});